name: Auto-merge lockfile PRs

on:
  pull_request:
    types: [opened, reopened, labeled, synchronize]

jobs:
  auto-merge:
    name: Auto-merge lockfile PR when checks pass
    runs-on: ubuntu-latest
    steps:
      - name: Check PR author and labels
        id: check_pr
        uses: actions/github-script@v6
        with:
          script: |
            const pr = context.payload.pull_request;
            if (!pr) return core.setOutput('do_merge', 'false');
            const author = pr.user?.login || '';
            const labels = pr.labels?.map(l => l.name) || [];
            const allowedAuthors = ['github-actions', 'github-actions[bot]', 'actions-user'];
            const hasAutomatedLabel = labels.includes('automated');
            const isAllowedAuthor = allowedAuthors.includes(author);
            core.info(`PR author=${author}, labels=${labels}`);
            if (isAllowedAuthor && hasAutomatedLabel) {
              core.setOutput('do_merge', 'true');
              core.setOutput('head_sha', pr.head.sha);
              core.setOutput('pr_number', pr.number);
            } else {
              core.setOutput('do_merge', 'false');
            }

      - name: Wait for checks to succeed
        if: steps.check_pr.outputs.do_merge == 'true'
        id: wait_checks
        uses: actions/github-script@v6
        with:
          script: |
            const headSha = core.getInput('head_sha') || steps.check_pr.outputs.head_sha;
            const prNumber = core.getInput('pr_number') || steps.check_pr.outputs.pr_number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const maxAttempts = 30;
            const delayMs = 10000; // 10s
            core.info(`Waiting for checks on ${headSha}`);
            for (let i = 0; i < maxAttempts; i++) {
              // get combined status
              const status = await github.rest.repos.getCombinedStatusForRef({ owner, repo, ref: headSha });
              core.info(`Attempt ${i+1}: combined state=${status.data.state}`);
              if (status.data.state === 'success') {
                core.setOutput('checks_ok', 'true');
                return;
              }
              if (status.data.state === 'failure') {
                core.setOutput('checks_ok', 'false');
                return;
              }
              await new Promise(res => setTimeout(res, delayMs));
            }
            core.setOutput('checks_ok', 'false');

      - name: Merge PR
        if: steps.check_pr.outputs.do_merge == 'true' && steps.wait_checks.outputs.checks_ok == 'true'
        uses: actions/github-script@v6
        with:
          script: |
            const prNumber = Number(steps.check_pr.outputs.pr_number);
            core.info(`Merging PR #${prNumber}`);
            try {
              await github.rest.pulls.merge({ owner: context.repo.owner, repo: context.repo.repo, pull_number: prNumber, merge_method: 'squash' });
              core.info('PR merged successfully');
            } catch (err) {
              core.info(`Merge failed: ${err}`);
              throw err;
            }
