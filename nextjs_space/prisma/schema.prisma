generator client {
    provider = "prisma-client-js"
    binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
    previewFeatures = ["driverAdapters"]
}

datasource db {
    provider = "postgresql"
    url      = env("PORTFOLIO_INTELLIGENCE_PRISMA_DATABASE_URL")
}

// Portfolio model to organize stocks into different portfolios
model Portfolio {
    id          String   @id @default(cuid())
    name        String   @unique
    description String?
    isLocked    Boolean  @default(false) // Prevent deletion of tickers from dashboard when locked
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt
    
    // Relations
    stocks      Stock[]
    
    @@index([name])
}

// Core stock/ticker information
model Stock {
    id          String   @id @default(cuid())
    ticker      String   @unique
    company     String
    type        String?  // 'Equity', 'ETF', etc.
    exchange    String?  // 'NASDAQ', 'NYSE', etc.
    region      String?  // 'United States', etc.
    currency    String?  @default("USD")
    sector      String?  // Company sector (e.g., 'Technology', 'Healthcare')
    industry    String?  // Company industry (e.g., 'Software', 'Pharmaceuticals')
    country     String?  // Company country (e.g., 'United States')
    description String?  @db.Text // Company description
    website     String?  // Company website URL
    employees   Int?     // Number of employees
    logoUrl     String?  // Company logo URL from Clearbit
    alternativeTickers String[] @default([]) // Alternative ticker symbols for matching (e.g., ['GOOGL'] for GOOG)
    isActive    Boolean  @default(true) // Whether the stock is in the user's portfolio
    rating      Int?     @default(0) // User's discretionary rating (0-5 stars)
    notes       String?  @db.VarChar(100) // User notes about the stock (max 100 chars)
    ratingUpdatedAt DateTime? // Last time the rating was updated
    addedAt     DateTime @default(now())
    updatedAt   DateTime @updatedAt
    
    // Portfolio relationship
    portfolioId String?
    portfolio   Portfolio? @relation(fields: [portfolioId], references: [id], onDelete: SetNull)

    // Relations
    stockData           StockData?
    priceHistory        PriceHistory[]
    analystRecommendations AnalystRecommendation[]
    socialSentiments    SocialSentiment[]
    news                News[]
    metrics             Metrics[]

    @@index([ticker])
    @@index([isActive])
    @@index([portfolioId])
}

// Current stock price and basic data
model StockData {
    id              String   @id @default(cuid())
    stockId         String   @unique
    stock           Stock    @relation(fields: [stockId], references: [id], onDelete: Cascade)
    
    currentPrice    Float?
    change          Float?
    changePercent   Float?
    week52High      Float?
    week52Low       Float?
    udf1            Float?   // User Defined Field 1 (formerly volume)
    udf2            Float?   // User Defined Field 2 (formerly marketCap)
    
    lastUpdated     DateTime @default(now())

    @@index([stockId])
}

// Historical price data for charts
model PriceHistory {
    id        String   @id @default(cuid())
    stockId   String
    stock     Stock    @relation(fields: [stockId], references: [id], onDelete: Cascade)
    
    date      DateTime
    price     Float
    volume    Float?
    
    createdAt DateTime @default(now())

    @@unique([stockId, date])
    @@index([stockId, date])
}

// Analyst recommendations
model AnalystRecommendation {
    id          String   @id @default(cuid())
    stockId     String   @unique
    stock       Stock    @relation(fields: [stockId], references: [id], onDelete: Cascade)
    
    strongBuy   Int      @default(0)
    buy         Int      @default(0)
    hold        Int      @default(0)
    sell        Int      @default(0)
    strongSell  Int      @default(0)
    consensus   String?  // 'Buy', 'Hold', 'Sell', 'N/A'
    priceTarget Float?
    
    lastUpdated DateTime @default(now())

    @@index([stockId])
}

// Social sentiment data
model SocialSentiment {
    id        String   @id @default(cuid())
    stockId   String   @unique
    stock     Stock    @relation(fields: [stockId], references: [id], onDelete: Cascade)
    
    positive  Int      @default(0)
    neutral   Int      @default(0)
    negative  Int      @default(0)
    overall   String?  // 'Positive', 'Neutral', 'Negative', 'N/A'
    
    lastUpdated DateTime @default(now())

    @@index([stockId])
}

// News articles
model News {
    id          String   @id @default(cuid())
    stockId     String
    stock       Stock    @relation(fields: [stockId], references: [id], onDelete: Cascade)
    
    title       String
    url         String?
    source      String?
    summary     String?  @db.Text
    publishedAt DateTime?
    
    createdAt   DateTime @default(now())

    @@index([stockId, publishedAt])
}

// Financial metrics - Daily snapshots for historical analysis and ML training
model Metrics {
    id                      String   @id @default(cuid())
    stockId                 String
    stock                   Stock    @relation(fields: [stockId], references: [id], onDelete: Cascade)
    snapshotDate            DateTime @default(now()) @db.Date
    
    // Valuation metrics
    peRatio                 Float?
    forwardPE               Float?
    pbRatio                 Float?
    psRatio                 Float?
    priceToBook             Float?
    evToRevenue             Float?
    evToEbitda              Float?
    pegRatio                Float?
    
    // Performance metrics
    beta                    Float?
    ytdReturn               Float?
    week52Return            Float?
    
    // Financial health
    debtToEquity            Float?
    roe                     Float?   // Return on Equity
    roa                     Float?   // Return on Assets
    operatingMargin         Float?
    profitMargin            Float?
    grossMargin             Float?
    currentRatio            Float?
    quickRatio              Float?
    
    // Growth metrics
    revenueGrowthQoQ        Float?
    earningsGrowthQoQ       Float?
    revenueGrowthYoY        Float?
    earningsGrowthYoY       Float?
    
    // Market data
    marketCap               Float?
    volume                  Float?
    averageVolume           Float?
    averageVolume10Day      Float?
    sharesOutstanding       Float?
    floatShares             Float?
    
    // Ownership
    heldByInsiders          Float?
    heldByInstitutions      Float?
    
    // Dividend metrics
    dividendYield           Float?
    payoutRatio             Float?
    
    // Per share metrics
    eps                     Float?
    bookValuePerShare       Float?
    
    createdAt               DateTime @default(now())

    @@unique([stockId, snapshotDate])
    @@index([stockId, snapshotDate])
    @@index([snapshotDate])
}

// Industry master list for diversification tracking
model Industry {
    id          String   @id @default(cuid())
    name        String   @unique
    displayOrder Int     @default(0)
    createdAt   DateTime @default(now())
    
    @@index([displayOrder])
}
